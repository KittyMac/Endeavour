#define PAMPHLET_PREPROCESSOR

#include <./figurehead/figurehead.html>
#include <./endeavour/endeavour.html>

#macro EDITOR(ID)
ID_ELEMENT(document##ID, VSTACK(),
    ELEMENT(HSTACK()BETWEEN()MARGIN(1,1,0,1),
        ID_ELEMENT(header##ID,LATO(1)FBLACK()START()BOTTOM(),Creating new document...)
        ANY_BUTTON(AROUND()BOTTOM()SIZEALL(2,2)CLICKABLE(),leaveDocument('ID'),
            IMAGE(SIZEALL(1,1),public/close.svg)
        )
    )
    ELEMENT(VSTACK()GROW()STRETCH()MINHEIGHT(10)STDSHADOW()MARGIN(0.5,1,1,1)BACKGROUND(255,255,255,1),
        ID_ELEMENT(editor##ID,GROW()PCTWIDTH(100)CLIPS(),)
    )
)
#endmacro

<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="user-scalable=no,width=device-width,initial-scale=1.0,viewport-fit=cover">
    <meta name="color-scheme" content="dark light">
    <title>PicaroonTemplate</title>
    <link rel="manifest" href="/public/manifest.json">
    <link rel="apple-touch-icon" sizes="192x192" href="/public/icon192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/public/icon512.png">
    
    #include <./shell.fonts.html>
    #include <./endeavour/editor.fonts.html>
    #include <./figurehead/figurehead.style>
    
    <script>
        // Required by Picaroon to hook up server-side actor with user to maintain state across connections
        if (sessionStorage.getItem("Session-Id") == undefined) {
            let sessionUUID = document.cookie.match(/SESSION_UUID=([A-Z0-9\-]*);?/);
            if (sessionUUID != undefined && sessionUUID.length > 1) {
                sessionStorage.setItem("Session-Id", sessionUUID[1]);
            }
        }
    </script>
        
    <script src="script.combined.js"></script>
    
    <style>        
        h1 {
            ROBOTO(2)
        }
        h2 {
            ROBOTO(1.5)
        }
        h3 {
            ROBOTO(1)
        }
        body {
            MAIN_BACKGROUND();
            VSCROLLING();
            -webkit-text-size-adjust: none;
        }
        *:focus {
            outline: none;
        }
    </style>
    
</head>
<body>
	<noscript>
		<div style="position:fixed;display:flex;justify-content:center;align-items:center;width:100%;height:100%;padding:0px;margin:0px;overflow:hidden;">
			<h1>This app requires Javascript to be enabled.</h1>
		</div>
	</noscript>
            
    ELEMENT(VSTACK()PCTMINHEIGHT(100)GROW()STRETCH(),
        GITHUB("https://github.com/KittyMac/Endeavour",#535457)
        
        ELEMENT(HSTACK()MINHEIGHT(5)PCTWIDTH(100)MARGIN(1,1,0,1),
            ELEMENT(VSTACK()GROW()MINHEIGHT(5),
                HEADER2(Endeavour)
                TEXT(Collaborative Swift editor using CodeMirror6)
            )
        )
        ELEMENT(HSTACK()END()MARGIN(0,0.5,0,0.5)GROW()SELF_STRETCH(),
            ID_BUTTON(newDocumentButton,PADDING(0,1,0,1),Shared Document,sharedDocument())
            HSPACE()
            ID_BUTTON(newDocumentButton,PADDING(0,1,0,1),New Document,newDocument())
            ID_BUTTON(joinDocumentButton,PADDING(0,1,0,1),Join Document,askJoinDocument())
        )
        ID_ELEMENT(documents, VSTACK()PCTWIDTH(100),)
        
    )
        
    ID_ELEMENT(alertsContainer,FULLSCREEN()ABSOLUTE()BACKGROUND(0,0,0,0.5)CENTER()CLIPS()HIDE(),)
    
    <script src="public/endeavour/editor.bundle.js"></script>
    
    <script>
        InitFigurehead();
        
        function handleCreateDocument(xhttp, serviceJson) {
            let documentUUID = serviceJson.documentUUID;
            let documentID = `document${documentUUID}`
            let editorID = `editor${documentUUID}`
            let headerID = `header${documentUUID}`
                            
            let html = `EDITOR(${documentUUID})`
            insertHtml(documents, html);
            
            let documentHeader = document.getElementById(headerID);
            documentHeader.innerText = `Document ${documentUUID}`;
            
            let documentStatus = function(status, isError) {
                let ignoreStatuses = [
                    //"Version mismatch"
                ];
                
                if (isError) {
                    FOREACH(ignoreStatus,ignoreStatuses) {
                        if (status.includes(ignoreStatus)) {
                            status = undefined;
                        }
                    }
                }
                
                if (status != undefined && documentHeader.innerText != status) {
                    print(status);
                    documentHeader.innerText = status;
                    
                    if (isError) {
                        documentHeader.style.color = `rgba(214,62,87,1)`;
                    } else {
                        documentHeader.style.color = `rgba(83,84,87,1)`;
                    }
                }
            }

            let editor = cm.CreateEditor(editorID, [
                cm.swiftSetup,
                cm.endeavourExtension(serviceJson, documentStatus)
            ], xhttp.responseText, true);
            
            let myDocument = document.getElementById(documentID);
            Laba.animate(myDocument, "!<200!f")
        }
        
        function askJoinDocument() {
            ask("Enter the document UUID to join",
                "",
                ["Cancel", "Join"], 
                [undefined, function(uuid) {
                    joinDocument(uuid);
                }]);
        }
        
        function leaveDocument(documentUUID) {
            endeavour.leave(documentUUID, function(xhttp, serviceJson) {
                let documentID = `document${documentUUID}`
                let myDocument = document.getElementById(documentID);
                let fromHeight = myDocument.clientHeight;
                Laba.animate(myDocument, "^50f0", function(item,t) {
                    item.style.height = lerp(fromHeight,0,t) + "px";
                }, function() {
                    removeFromParent(myDocument);
                });
            });
        }
        
        function sharedDocument() {
            endeavour.join("SwiftSample", handleCreateDocument);
        }
        
        function newDocument() {
            endeavour.new(handleCreateDocument);
        }
        
        function joinDocument(documentUUID) {
            endeavour.join(documentUUID, handleCreateDocument);
        }

    </script>
    
</body>
</html>